#!/usr/bin/env ruby
# Usage: posix-spawn-bm
require 'posix-spawn'
require 'benchmark'

allocate   = 100 * (1024 ** 2)
iterations = 1_000

include Benchmark

# bloat the process
bloat = 'x' * allocate

# benchmark vspawn (vfork+exec) vs. fspawn (fork+exec)
puts "benchmarking the various spawns over #{iterations} runs" +
     " at #{allocate / (1024 ** 2)}M res"
bm 40 do |x|
  x.report("fspawn (fork/exec):") do
    iterations.times do
      pid = POSIX::Spawn.fspawn('true')
      Process.wait(pid)
    end
  end
  x.report("pspawn (posix_spawn):") do
    iterations.times do
      pid = POSIX::Spawn.pspawn('true')
      Process.wait(pid)
    end
  end
end
